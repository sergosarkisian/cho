Download image form susestudio
cd to prepare folder
mkdir loop
tar -xzf {IMAGE}.tar.gz ./
mount -o loop,offset=1048576  {IMAGE} ./loop/

cp /etc/resolv.conf ./loop/etc/
cp /etc/sysconfig/proxy ./loop/etc/sysconfig/
cp /media/sysdata/rev5/techpool/ontology/linux_sys/grub2/etc_default_grub-vm ./loop/etc/default/grub
cp /media/sysdata/rev5/techpool/ontology/linux_sys/dracut/dracut.conf-vm ./loop/etc/dracut.conf
cp /media/sysdata/rev5/techpool/ontology/linux_sys/grub2/boot_grub2_grub.cfg_vminit ./loop/boot/grub2/grub.cfg
sed -i "s/set default=.*/set default=\"hvm\"/" ./loop/boot/grub2/grub.cfg

#mounts - new
#cp /media/sysdata/rev5/techpool/ontology/linux_sys/systemd/mounts/-.mount loop/etc/systemd/system/
#cp /media/sysdata/rev5/techpool/ontology/linux_sys/systemd/mounts/dev-disk-by\\\\x2dlabel-swap.swap loop/etc/systemd/system/
#cp /media/sysdata/rev5/techpool/ontology/linux_sys/systemd/mounts/media-logs.mount loop/etc/systemd/system/

#mounts - old
echo "LABEL=logs           /media/logs          ext4       noatime,acl,user_xattr 1 1" >> loop/etc/fstab
echo "LABEL=swap           swap                 swap       defaults              0 0" >> loop/etc/fstab
#

mkdir -p loop/media/sysdata/rev5/static
cp /media/sysdata/rev5/techpool/ontology/linux_sys/suse-network/ifcfg-tmpl loop/media/sysdata/rev5/static/
cp /media/sysdata/rev5/techpool/ontology/linux_sys/suse-network/hosts loop/media/sysdata/rev5/static/
cp /media/sysdata/rev5/techpool/ontology/management/rev5/naming.sh  loop/media/sysdata/rev5/static/

cp /media/sysdata/rev5/techpool/ontology/management/rev5/init/rev5_init_auto_xen.sh  loop/media/sysdata/rev5/static/
cp /media/sysdata/rev5/techpool/ontology/management/rev5/init/rev5_init_svn.sh  loop/media/sysdata/rev5/static/
rm -f  loop/etc/systemd/system/rev5_init_auto_xen.service && cp /media/sysdata/rev5/techpool/ontology/management/rev5/init/_systemd/rev5_init_auto_xen.service loop/etc/systemd/system/rev5_init_auto_xen.service

##tmp 
rm -f  loop/etc/systemd/system/rev5_remount.service && cp /media/sysdata/rev5/techpool/ontology/management/rev5/_dev/rev5_remount.service loop/etc/systemd/system/rev5_remount.service
cp /media/sysdata/rev5/techpool/ontology/management/rev5/_dev/remount.sh  loop/media/sysdata/rev5/static/

##

mount -t proc /proc loop/proc/ &&  mount -t sysfs /sys loop/sys/ && mount -o bind /dev loop/dev/ && chroot loop
e2label /dev/loop0 system
tune2fs -O extents,uninit_bg,dir_index /dev/loop0
fsck.ext4 -fnv /dev/loop0
find / -xdev -type f -print0 | xargs -0 chattr +e
find / -xdev -type d -print0 | xargs -0 chattr +e

#SYSTEMD
systemctl enable rev5_init_auto_xen
#

## tmp
systemctl enable rev5_remount.service
##

# put repos from repo.sh
zypper --non-interactive --gpg-auto-import-keys ref
zypper in --force kernel-default kernel-xen
zypper --non-interactive --gpg-auto-import-keys dup

#rm old kernels -  zypper rm "kernel-* == {VER}"

## verify kernel version - curr = 4.1.12-1
cd /boot
wget http://public.edss.ee/rev5/vm/vm_boot.tar.gz
tar -xzf vm_boot.tar.gz
cp vm_boot/* ./
rm /boot/vmlinuz && ln -s /boot/vmlinuz-4.1.12-1-default /boot/vmlinuz
rm /boot/vmlinuz-xen && ln -s /boot/vmlinuz-4.1.12-1-xen /boot/vmlinuz-xen

rm /boot/initrd && ln -s /boot/initrd-4.1.12-1-default /boot/initrd
rm /boot/initrd-xen && ln -s /boot/initrd-4.1.12-1-xen /boot/initrd-xen
##

rm /etc/resolv.conf
rm -f /var/log/*/*
rm -f /var/log/*.log
rm /root/.bash_history
history -c
exit 
 #end of chroot

umount loop/dev && umount loop/proc && umount loop/sys && umount loop

###END

--
mkfs.ext4 -L "logs" ./logs.raw
mkswap -L "swap" swap.raw 
 
 
--add
+ firstboot template
