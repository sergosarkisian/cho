

   

	
	
###########################
###  acl_check_mime     ###
###########################

acl_check_mime:





.ifdef SCORE_ATTACH_ARCH	
warn
		message = Sorry, your have dangerous archived (e) content in attachment(s).
		decode = $mime_filename
        condition = ${lookup{$mime_filename}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/ext_arch}{yes}{no}}
        condition = ${run{/bin/sh  /etc/faster/cmdb/techpool/exim/common/handlers/archive_check.sh "$message_exim_id"}{0}{1}}
        #
		set acl_c_rule = delivery_deny_attach_arch_1
		set acl_c_score_mta_inc = SCORE_ATTACH_ARCH
		set acl_c_score_reason = Dangerous (ext) archived content in attachment(s) - $mime_filename
		set acl_c_msg_view = $acl_c_msg_view_def
		set acl_c_acl_action = $acl_c_acl_action_def
		set acl_c_advlog_inc = $acl_c_advlog_inc_def		
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_content = ${eval10:$acl_c_score_content + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}	
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
        add_header     = X-Spam-Score-Check: added $acl_c_score_mta_inc scores: $acl_c_score_reason            	
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_delivery_deny_attach_arch_1 = 1			
		
	warn
		message = Sorry, your have dangerous archived (m) content in attachment(s). 
		decode = $mime_filename
        condition = ${lookup{$mime_filename}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/ext_arch}{no}{yes}}		
        condition = ${lookup{$mime_content_type}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/mime_arch}{yes}{no}}
        condition = ${run{/bin/sh  /etc/faster/cmdb/techpool/exim/common/handlers/archive_check.sh "$message_exim_id"}{0}{1}}	
		#
		set acl_c_rule = delivery_deny_attach_arch_2
		set acl_c_score_mta_inc = SCORE_ATTACH_ARCH	
		set acl_c_score_reason = Dangerous (mime) archived content in attachment(s) - $mime_filename
		set acl_c_msg_view = $acl_c_msg_view_def
		set acl_c_acl_action = $acl_c_acl_action_def
		set acl_c_advlog_inc = $acl_c_advlog_inc_def		
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_content = ${eval10:$acl_c_score_content + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}	
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
        add_header     = X-Spam-Score-Check: added $acl_c_score_mta_inc scores: $acl_c_score_reason            	
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_delivery_deny_attach_arch_2 = 1			
.endif



.ifdef SCORE_ATTACH_ALLOW

accept 
        condition = ${lookup{$mime_filename}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/ext_allow}{yes}{no}}
        #
		set acl_c_rule = delivery_accept_attach_allow				
		set acl_c_score_reason = Allowed (ext) content in attachment(s) -$mime_filename
		set acl_c_msg_view = delivery
		set acl_c_acl_action = accept
		set acl_c_advlog_inc = $acl_c_advlog_inc_def
        set acl_c_advlog = $acl_c_advlog \;  $acl_c_advlog_inc;					
		#		
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"

		
accept 
        condition = ${lookup{$mime_content_type}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/mime_allow}{yes}{no}}
        #
		set acl_c_rule = delivery_accept_attach_allow				
		set acl_c_score_reason = Allowed (mime) content in attachment(s) - $mime_filename
		set acl_c_msg_view = delivery
		set acl_c_acl_action = accept
		set acl_c_advlog_inc = $acl_c_advlog_inc_def
        set acl_c_advlog = $acl_c_advlog \;  $acl_c_advlog_inc;					
		#		
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		

.endif


.ifdef SCORE_ATTACH_DANGER	

warn 
		message = Sorry, your have dangerous (e) content in attachment(s).
        condition = ${lookup{$mime_filename}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/ext_danger}{yes}{no}}
		#
		set acl_c_rule = delivery_deny_attach_danger_1
		set acl_c_score_mta_inc = SCORE_ATTACH_DANGER
		set acl_c_score_reason = Dangerous (ext) content in attachment(s) -$mime_filename
		set acl_c_msg_view = $acl_c_msg_view_def
		set acl_c_acl_action = $acl_c_acl_action_def
		set acl_c_advlog_inc = $acl_c_advlog_inc_def			
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_content = ${eval10:$acl_c_score_content + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}	
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
        add_header     = X-Spam-Score-Check: added $acl_c_score_mta_inc scores: $acl_c_score_reason            	
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_delivery_deny_attach_danger_1 = 1			

		
warn 
		message = Sorry, your have dangerous (m) content in attachment(s).
        condition = ${lookup{$mime_filename}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/ext_danger}{no}{yes}}		
        condition = ${lookup{$mime_content_type}wildlsearch{/etc/faster/cmdb/techpool/exim/common/data/mime/mime_danger}{yes}{no}}
		#
		set acl_c_rule = delivery_deny_attach_danger_2
		set acl_c_score_mta_inc = SCORE_ATTACH_DANGER
		set acl_c_score_reason = Dangerous (mime) content in attachment(s) -$mime_filename
		set acl_c_msg_view = $acl_c_msg_view_def
		set acl_c_acl_action = $acl_c_acl_action_def
		set acl_c_advlog_inc = $acl_c_advlog_inc_def		
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_content = ${eval10:$acl_c_score_content + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}	
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
        add_header     = X-Spam-Score-Check: added $acl_c_score_mta_inc scores: $acl_c_score_reason            	
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_delivery_deny_attach_danger_2 = 1			
.endif


accept	




###########################
###  acl_check_data     ###
###########################

acl_check_data:

    ###
###SCORES###
warn
set acl_c_section = acl_check_data
set acl_c_message_id = $message_exim_id
set acl_c_recipient = $recipients
###SCORES###
    ###

    


.ifdef  SCORE_NO_SUBJ_OR_BODY
  # No Subject or Body => Score: SCORE_NO_SUBJ_OR_BODY 
  warn   
		!condition = ${if def:h_Subject:}
		condition = ${if <{$body_linecount}{1}{true}{false}}
		#
		set acl_c_rule = score_no_subj_or_body
		set acl_c_score_mta_inc = SCORE_NO_SUBJ_OR_BODY
		set acl_c_score_reason = No Subject or Body
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_mta = ${eval:$acl_c_score_mta + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}			
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
        add_header     = X-Spam-Score-Check: added $acl_c_score_mta_inc scores: $acl_c_score_reason        
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_score_no_subj_or_body = 1			
.endif

###########  MTA SCORE END ###########

        

#  	Score $acl_c_score_total is > deny_hard ($acl_c_deny_hard) => DENY
deny 
		message = Sorry, your spam score is very high
		condition = ${if >={$acl_c_score_total}{$acl_c_deny_hard}{yes}{no}}
		#
		set acl_c_rule = delivery_deny_data_1		
		set acl_c_score_reason = Score $acl_c_score_total is > deny_hard ($acl_c_deny_hard)
		set acl_c_msg_view = delivery
		set acl_c_acl_action = deny
		set acl_c_advlog_inc = $acl_c_advlog_inc_def
        set acl_c_advlog = $acl_c_advlog \;  $acl_c_advlog_inc;
		#		
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		

#SA



.ifdef CONTENT_FILTRATION
  # Content filtration => Score: $spam_score_int 
  warn   
		spam = nobody:true
		condition = ${if < {$message_size}{300K}}
		condition = ${if or {{>={$acl_c_score_mta}{SCORE_ACCEPT}}{eqi{$acl_c_recipient}{testuser@cone.ee}}}}
		#
		set acl_c_rule = score_content_filtration
		set acl_c_score_mta_inc = $spam_score_int
		set acl_c_score_reason = Content filtration
		#
		set acl_c_score_prev = $acl_c_score_total
		set acl_c_score_content = ${eval10:$acl_c_score_content + $acl_c_score_mta_inc}
		set acl_c_score_total = ${eval10:$acl_c_score_mta + $acl_c_score_content}	
        set acl_c_spamlog = $acl_c_spamlog $acl_c_score_reason=+$acl_c_score_mta_inc;
        #
		add_header = X-Spam-Bar: $spam_bar
		add_header = X-Spam-Content-Report: $spam_report
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		#
		set acl_c_fact_mta_score_content_filtration = 1			
.endif




###########  QUEUEING DELIVERY ###########

.ifdef SCORE_FLAG_SPAM
  ##Add spam flag for MS Exchange
  warn
		condition = ${if >={$acl_c_score_mta}{SCORE_FLAG_SPAM}{yes}{no}}
		add_header     = X-Spam-Flag: Yes
		add_header     = X-Spam-Flag: yes
		add_header     = X-Spam-Flag: YES
		add_header     = x-spam-flag: yes
		#
		set acl_c_fact_mta_score_flag_spam = 1			
		
.endif



  warn 
		add_header = X-Spam-Score-MTA: $acl_c_score_mta
		add_header = X-Spam-Score-Content: $acl_c_score_content
		add_header = X-Spam-Score-Total: $acl_c_score_total
		add_header = X-Spam-Score-MTA-details: $acl_c_spamlog

accept
		#
		set acl_c_score_reason = Accepted with score $acl_c_score_mta
		set acl_c_rule = accept_final			
		set acl_c_msg_view = delivery
		set acl_c_acl_action = delivery
		set acl_c_advlog_inc = $acl_c_advlog_inc_def
        set acl_c_advlog = $acl_c_advlog \;  $acl_c_advlog_inc;		
		#		
		logwrite ="msg_class":"$acl_c_msg_class", "msg_view":"$acl_c_msg_view", "acl_action":"$acl_c_acl_action", "acl_section":"$acl_c_section", "acl_rule":"$acl_c_rule", "message_id":"$acl_c_message_id", "sender_host_address":"$sender_host_address", "sender_host_name":"$sender_host_name", "to":"$acl_c_recipient", "from":"$sender_address_local_part@$sender_address_domain", "from_server":"$sender_fullhost", "acl_score_reason":"$acl_c_score_reason", "acl_spamlog":"$acl_c_spamlog", "acl_score_mta":"$acl_c_score_mta", "acl_score_content":"$acl_c_score_content", "acl_score_total":"$acl_c_score_total", "acl_advlog_inc":"$acl_c_advlog_inc", "acl_advlog":"$acl_c_advlog", "acl_score_inc":"$acl_c_score_mta_inc", "acl_score_prev":"$acl_c_score_prev"
		
		
